{% extends 'layout/base_vente.html' %}

{% block title %}Liste des Ventes{% endblock %}

{% block main_content %}
<div class="container">
    <h2 class="text-center mb-4">Liste des Ventes</h2>
    <input type="text" id="search-bar" class="form-control mb-3" placeholder="Rechercher une vente..." onkeyup="searchVentes()">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Vendeur</th>
                <th>Date de Vente</th>
                <th>Total Vente</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="ventes-list">
            {% for vente in ventes %}
                <tr>
                    <td>{{ vente.id_User.username }}</td>
                    <td>
                        {% if vente.dateVente %}
                            {{ vente.dateVente|date:"d/m/Y H:i" }}
                        {% else %}
                            Non spécifiée
                        {% endif %}
                    </td>
                    <td>{{ vente.totalVente }}</td>
                    <td>
                        <button onclick="showVenteDetail({{ vente.id_Vente }})" class="btn btn-primary">Détails</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal for Vente Detail -->
<div class="modal fade" id="venteDetailModal" tabindex="-1" role="dialog" aria-labelledby="venteDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="venteDetailModalLabel">Détails de la Vente</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="venteDetailBody">
                <!-- Vente details will be inserted here dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" aria-label="Close" onclick="closeModal()">Fermer</button>
            </div>
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    function showVenteDetail(venteId) {
        $.get("{% url 'vente_detail' id=0 %}".replace("0", venteId), function(data) {
            if (data.modal_content) {
                // Injecter le contenu dans le modal
                document.getElementById('venteDetailBody').innerHTML = data.modal_content;
                // Afficher le modal
                $('#venteDetailModal').modal('show');
            } else {
                alert("Erreur lors du chargement des détails.");
            }
        }).fail(function() {
            alert("Erreur lors du chargement des détails.");
        });
    }

    function closeModal() {
        $('#venteDetailModal').modal('hide');
    }

    function searchVentes() {
        const searchQuery = document.getElementById('search-bar').value.toLowerCase();
        const ventes = document.querySelectorAll('#ventes-list tr');

        ventes.forEach(vente => {
            const vendeur = vente.querySelector('td:nth-child(1)').innerText.toLowerCase();
            const dateVente = vente.querySelector('td:nth-child(2)').innerText.toLowerCase();
            const totalVente = vente.querySelector('td:nth-child(3)').innerText.toLowerCase();
            const matches = vendeur.includes(searchQuery) || dateVente.includes(searchQuery) || totalVente.includes(searchQuery);
            vente.style.display = matches ? 'table-row' : 'none';
        });
    }
</script>

{% endblock %}
